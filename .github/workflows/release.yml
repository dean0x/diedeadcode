name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: ddd-darwin-arm64
            binary: ddd

          # macOS x64
          - os: macos-14
            target: x86_64-apple-darwin
            artifact: ddd-darwin-x64
            binary: ddd

          # Linux x64 (glibc)
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact: ddd-linux-x64
            binary: ddd

          # Linux ARM64 (glibc)
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            artifact: ddd-linux-arm64
            binary: ddd
            cross: true

          # Linux x64 (musl)
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            artifact: ddd-linux-x64-musl
            binary: ddd

          # Linux ARM64 (musl)
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            artifact: ddd-linux-arm64-musl
            binary: ddd
            cross: true

          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: ddd-win32-x64.exe
            binary: ddd.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl-tools (Linux musl)
        if: contains(matrix.target, 'musl') && !matrix.cross
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install cross (for cross-compilation)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} ${{ matrix.artifact }}
          chmod +x ${{ matrix.artifact }}

      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          copy target\${{ matrix.target }}\release\${{ matrix.binary }} ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          retention-days: 1

  publish-npm:
    name: Publish npm packages
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate npm packages
        run: node scripts/generate-npm-packages.mjs ${{ steps.version.outputs.VERSION }} artifacts

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in cli-darwin-arm64 cli-darwin-x64 cli-linux-x64 cli-linux-arm64 cli-linux-x64-musl cli-linux-arm64-musl cli-win32-x64; do
            echo "Publishing @diedeadcode/$pkg..."
            npm publish npm/$pkg --access public --provenance
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish npm/diedeadcode --access public --provenance

  publish-crates:
    name: Publish to crates.io
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --allow-dirty

  github-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create checksums
        run: |
          cd artifacts
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.VERSION }}
          body: |
            ## Installation

            ### npm (recommended)
            ```bash
            npm install -D diedeadcode
            # or
            npx diedeadcode .
            ```

            ### Cargo
            ```bash
            cargo install diedeadcode
            ```

            ### Homebrew (macOS)
            ```bash
            brew install dean0x/tap/diedeadcode
            ```

            ### Direct download
            Download the appropriate binary for your platform below.

            ## Checksums (SHA256)
            ```
            $(cat artifacts/checksums.txt)
            ```
          files: |
            artifacts/ddd-darwin-arm64
            artifacts/ddd-darwin-x64
            artifacts/ddd-linux-x64
            artifacts/ddd-linux-arm64
            artifacts/ddd-linux-x64-musl
            artifacts/ddd-linux-arm64-musl
            artifacts/ddd-win32-x64.exe
            artifacts/checksums.txt
          draft: false
          prerelease: false

  update-homebrew:
    name: Update Homebrew tap
    needs: github-release
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: dean0x/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download macOS binaries for checksums
        run: |
          curl -sL "https://github.com/dean0x/diedeadcode/releases/download/v${{ steps.version.outputs.VERSION }}/ddd-darwin-arm64" -o ddd-darwin-arm64
          curl -sL "https://github.com/dean0x/diedeadcode/releases/download/v${{ steps.version.outputs.VERSION }}/ddd-darwin-x64" -o ddd-darwin-x64

      - name: Calculate checksums
        id: checksums
        run: |
          echo "ARM64_SHA256=$(sha256sum ddd-darwin-arm64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "X64_SHA256=$(sha256sum ddd-darwin-x64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cat > homebrew-tap/Formula/diedeadcode.rb << 'EOF'
          class Diedeadcode < Formula
            desc "Conservative TypeScript dead code detection"
            homepage "https://github.com/dean0x/diedeadcode"
            version "${{ steps.version.outputs.VERSION }}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/dean0x/diedeadcode/releases/download/v${{ steps.version.outputs.VERSION }}/ddd-darwin-arm64"
                sha256 "${{ steps.checksums.outputs.ARM64_SHA256 }}"
              else
                url "https://github.com/dean0x/diedeadcode/releases/download/v${{ steps.version.outputs.VERSION }}/ddd-darwin-x64"
                sha256 "${{ steps.checksums.outputs.X64_SHA256 }}"
              end
            end

            def install
              if Hardware::CPU.arm?
                bin.install "ddd-darwin-arm64" => "ddd"
              else
                bin.install "ddd-darwin-x64" => "ddd"
              end
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/ddd --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/diedeadcode.rb
          git commit -m "Update diedeadcode to ${{ steps.version.outputs.VERSION }}"
          git push
